# This template configures Nginx to proxy requests to different ports based on the hostname.
# It dynamically sets the listen port and the proxy_pass directive for the forest or lotus metrics server.

events {
    use                 epoll;
    worker_connections  128;
}

http {
    # Node exporter scrape endpoint
    server {
        listen              {{ node_exporter.public_port }};
        location / {
            auth_basic      "Restricted";
            auth_basic_user_file  /etc/nginx/.htpasswd;
            proxy_pass      http://127.0.0.1:{{ node_exporter.port }};
        }
    }
    # Forest scrape endpoint
    server {
        listen              {{ forest.metrics.host_port }};
        location / {
            auth_basic      "Restricted";
            auth_basic_user_file  /etc/nginx/.htpasswd;
            proxy_pass      http://127.0.0.1:{{ forest.metrics.port }};
        }
    }
    {% if 'forest_rpcnodes' in group_names %}
    # Forest RPC endpoint with CORS enabled on RPC port
    server {
        listen              {{ forest.rpc.host_port }};
        location / {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type';
            proxy_pass      http://127.0.0.1:{{ forest.rpc.port }};
            # Handle preflight requests
            if ($request_method = OPTIONS) {
                return 204;
            }
        }
    }
    {% endif %}
}
